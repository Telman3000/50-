# ─────────────────────────────────────────────────────────────────────────────
# Используем минимальный образ Python 3.11
FROM python:3.11-slim

# ─────────────────────────────────────────────────────────────────────────────
# Рабочая директория внутри контейнера
WORKDIR /app

# ─────────────────────────────────────────────────────────────────────────────
# Настраиваем pip:
# - PIP_DEFAULT_TIMEOUT увеличивает таймаут сети до 100 секунд
# - PIP_INDEX_URL ставит зеркальный PyPI (Tsinghua) для более быстрого скачивания
ENV PIP_DEFAULT_TIMEOUT=100 \
    PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple

# ─────────────────────────────────────────────────────────────────────────────
# Обновляем сам pip до последней версии перед установкой пакетов
RUN pip install --upgrade pip

# ─────────────────────────────────────────────────────────────────────────────
# Копируем файл зависимостей и ставим их:
# --no-cache-dir отключает локальный кэш, чтобы не раздувать образ
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ─────────────────────────────────────────────────────────────────────────────
# Копируем весь код приложения после установки зависимостей
COPY . .

# ─────────────────────────────────────────────────────────────────────────────
# Открываем порт, на котором uvicorn будет слушать запросы
EXPOSE 8000

# ─────────────────────────────────────────────────────────────────────────────
# Запускаем приложение через uvicorn
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
